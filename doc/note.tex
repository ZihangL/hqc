\documentclass{article}
\usepackage[letterpaper,top=2cm,bottom=2cm,left=1.5cm,right=1.5cm,marginparwidth=1.75cm]{geometry}
\usepackage{amsmath}
\usepackage{braket}
\usepackage{graphicx}
\usepackage{indentfirst}
\setlength{\parindent}{0pt}
\usepackage[colorlinks=true, allcolors=blue]{hyperref}
\usepackage{listings}
\lstset{
    columns=fixed,       
    numbers=left,
    frame=none, 
    backgroundcolor=\color[RGB]{245,245,244},
    keywordstyle=\color[RGB]{40,40,255},
    commentstyle=\it\color[RGB]{0,96,96},
    stringstyle=\rmfamily\slshape\color[RGB]{128,0,0},
    showstringspaces=false,
}

\title{Hydrogen note}
\author{Zihang}

\begin{document}
\maketitle
\section{Atomic orbitals}
    Basis set is the starting point of quantum chemistry calculation.
    In general, atomic orbitals are preferred by chemists,
    and plane wave orbitals are preferred by physicists.
    Because atomic orbitals, such as GTOs and STOs, are good for molecules.
    And physicist cares about solid more than molecules.

    In hydrogen problem, PBC atomic orbital maybe a good starting point.
    
    \subsection{Gaussian type orbitals}
        We use Gaussian type orbitals (GTOs) as basis functions.
        The basis we used here, as well as in \href{https://pyscf.org/}{PYSCF},
        is a little bit different from \href{https://www.cp2k.org/basis_sets}{CP2K}.
        Take \href{https://github.com/pyscf/pyscf/blob/master/pyscf/pbc/gto/basis/gth-dzvp.dat}{gth-dzvp} as an example.
        \begin{lstlisting}
            H DZVP-GTH
                2
                1  0  0  4  2
                        8.3744350009  -0.0283380461   0.0000000000
                        1.8058681460  -0.1333810052   0.0000000000
                        0.4852528328  -0.3995676063   0.0000000000
                        0.1658236932  -0.5531027541   1.0000000000
                2  1  1  1  1
                        0.7270000000   1.0000000000
        \end{lstlisting}
        We explain the file-format using in the example.

        \begin{itemize}
            \item[] \textbf{Line 1} are the name of the element and basis set.
            \item[] \textbf{Line 2} specifies the number of sets this basis set contains (here 2).
            \item[] \textbf{Line 3} specifies the composition of the first set.
            \begin{itemize}
                \item[] The first number specifies the principal quantum number (here: 1).
                \item[] The second number specifies the minimal angular quantum number $l_{min}$ (here: 0).
                \item[] The third number specifies the maximal angular quantum number $l_{max}$ (here: 0).
                \item[] The fourth number specifies the number of exponents $N$ (here: 4).
            \end{itemize}
            \item[] The following numbers specify the number of contracted basis functions for each angular momentum value $n_l$ (here only $l=0$).
            \begin{itemize}
                \item[] The fifth number specifies the number of contractions for $l=0$ (here: 2).
            \end{itemize}
            \item[] \textbf{Line 4-7} specify the coefficients of the first set. Each line consists of an exponent $\alpha_j$
            , followed by contraction coefficients $c_{ij}$.
            \item[] \textbf{Line 8} specifies the composition of the second set.
            \item[] \textbf{Line 9} specifies the coefficients of the second set.
        \end{itemize}

        We use the same contracted GTOs with \href{https://pyscf.org/}{PYSCF}.

        \begin{equation}
            \varphi_i(\textbf{r}) = N_{\textbf{m}}x^{m_x}y^{m_y}z^{m_z}\sum_{j=1}^NN_{j}c_{ij}\exp\left(-\alpha_{j}\cdot r^2\right)
        \end{equation}

        Where $N_{\textbf{m}}$ and $N_{j}$ are normalization factors.
        So the five bases of hydrogen in the example are as follows,
        ~\\
        \hrule
        $ \varphi_1(\textbf{r}) = \left(\frac{2}{\pi}\right)^{\frac{3}{4}}\left[
            0.028\cdot(8.374)^{\frac{3}{4}}\cdot e^{-8.374r^2}+
            0.133\cdot(1.806)^{\frac{3}{4}}\cdot e^{-1.806r^2}+
            0.400\cdot(0.485)^{\frac{3}{4}}\cdot e^{-0.485r^2}+
            0.553\cdot(0.166)^{\frac{3}{4}}\cdot e^{-0.166r^2}\right] $
 
        $ \varphi_2(\textbf{r}) = \left(\frac{2}{\pi}\right)^{\frac{3}{4}}
            1.000\cdot(0.166)^{\frac{3}{4}}\cdot e^{-0.166r^2} $

        $ \varphi_3(\textbf{r}) = 1.000\cdot x e^{-0.727r^2} $

        $ \varphi_4(\textbf{r}) = 1.000\cdot y e^{-0.727r^2} $

        $ \varphi_5(\textbf{r}) = 1.000\cdot z e^{-0.727r^2} $
        \hrule
        ~\\
        Normalization factors may be different from \href{https://pyscf.org/}{PYSCF}. To be verified.
        
    \subsection{PBC orbitals}
    Crystalline orbitals Gaussian basis function $\phi$ is a lattice sum over local contracted Gaussians $\varphi$
    \begin{equation}
        \phi_{\textbf{k},i}(\textbf{r}) = \sum_{\textbf{T}}e^{i\textbf{k}\cdot\textbf{T}}\varphi_i(\textbf{r}-\textbf{T})\label{ao}
    \end{equation}
    where $\textbf{k}$ is a vector in the first Brillouin zone and $\textbf{T}$ is a lattice translational vector.
    It should be noted that this $\phi_{\textbf{k},i}(\textbf{r})$ is not a periodic function, 
    so PBC here maybe a misleading word, TBC is more accurate.
    According to Bloch's theorem, we have
    \begin{equation}
        \phi_{\textbf{k},i}(\textbf{r}) = e^{i\textbf{k}\cdot\textbf{r}}u_{\textbf{k},i}(\textbf{r})
    \end{equation}
    where $u_{\textbf{k},i}(\textbf{r})$ is fully periodic with respect to all lattice translations.
    Therefore, we can exactly expand the crystalline AOs in a set of auxiliary plane-waves
    \begin{gather}
        \phi_{\textbf{k},i}(\textbf{r}) = \sum_{\textbf{G}}\phi_{\textbf{k},i}(\textbf{G})e^{i(\textbf{k}+\textbf{G})\cdot\textbf{r}}\label{ao_ft}\\
        \phi_{\textbf{k},i}(\textbf{G}) = \frac{1}{\Omega}\int_\Omega d\textbf{r}\ \phi_{\textbf{k},i}(\textbf{r})e^{-i(\textbf{k}+\textbf{G})\cdot\textbf{r}}\label{ao_ft_coeff}
    \end{gather}
    In practice, we can get PBC orbitals both from eq.\eqref{ao} and eq.\eqref{ao_ft}. 
    The summations in these two equations are done in a cutoff range.
    To compare the computational complexity of eq.\eqref{ao} and eq.\eqref{ao_ft}, 
    we have to specify the fourier coefficients by using eq.\eqref{ao_ft_coeff}.
    \begin{align*}
        \phi_{\textbf{k},i}(\textbf{G}) &= \frac{1}{\Omega}\int_\Omega d\textbf{r}\ \phi_{\textbf{k},i}(\textbf{r})e^{-i(\textbf{k}+\textbf{G})\cdot\textbf{r}}\\
        &= \frac{1}{\Omega}\int_\Omega d\textbf{r}\ \sum_{\textbf{T}}e^{i\textbf{k}\cdot\textbf{T}}\varphi_i(\textbf{r}-\textbf{T})e^{-i(\textbf{k}+\textbf{G})\cdot\textbf{r}}\\
        &= \frac{1}{\Omega}\sum_{\textbf{T}}e^{i\textbf{k}\cdot\textbf{T}}\int_\Omega d\textbf{r}\ \varphi_i(\textbf{r}-\textbf{T})e^{-i(\textbf{k}+\textbf{G})\cdot\textbf{r}}\\
        &= \frac{1}{\Omega}\sum_{\textbf{T}}e^{i\textbf{k}\cdot\textbf{T}}
            \int_{\Omega-\textbf{T}} d\textbf{r}'\ \varphi_i(\textbf{r}')e^{-i(\textbf{k}+\textbf{G})\cdot(\textbf{r}'+\textbf{T})}\\
        &= \frac{1}{\Omega}\sum_{\textbf{T}}\int_{\Omega-\textbf{T}} d\textbf{r}'\ \varphi_i(\textbf{r}')e^{-i(\textbf{k}+\textbf{G})\cdot\textbf{r}'}\\
        &= \frac{1}{\Omega}\int d\textbf{r}'\ \varphi_i(\textbf{r}')e^{-i(\textbf{k}+\textbf{G})\cdot\textbf{r}'}
    \end{align*}
    For GTOs, the fourier coefficients can be performed analytically
    \begin{equation}
        \phi_{\textbf{k},i}(\textbf{G}) = \frac{1}{\Omega}\int d\textbf{r}\ \varphi_i(\textbf{r})e^{-i(\textbf{k}+\textbf{G})\cdot\textbf{r}}\label{ao_ft_coeff1}
    \end{equation}
    Take a simple s orbital $\varphi(\textbf{r})=e^{-\alpha r^2}$ as an example.
    Using eq.\eqref{ao}, we can get PBC orbitals
    \begin{equation}
        \phi_{\textbf{k}}(\textbf{r}) = \sum_{\textbf{T}}e^{i\textbf{k}\cdot\textbf{T}}e^{-\alpha (\textbf{r}-\textbf{T})^2}\label{7}
    \end{equation}
    On the other hand, the fourier coefficients from eq.\eqref{ao_ft_coeff1} is
    \begin{equation*}
        \phi_{\textbf{k}}(\textbf{G}) = \frac{1}{\Omega}\left(\frac{\pi}{\alpha}\right)^{\frac{3}{2}}\exp\left[-\frac{(\textbf{k}+\textbf{G})^2}{4\alpha}\right]
    \end{equation*}
    Using eq.\eqref{ao_ft}, we can get PBC orbitals
    \begin{equation}
        \phi_{\textbf{k}}(\textbf{r}) = \frac{1}{\Omega}\left(\frac{\pi}{\alpha}\right)^{\frac{3}{2}}\sum_{\textbf{G}}
        \exp\left[-\frac{(\textbf{k}+\textbf{G})^2}{4\alpha}\right]e^{i(\textbf{k}+\textbf{G})\cdot\textbf{r}}\label{8}
    \end{equation}
    Compare these two equations eq.\eqref{7} and eq.\eqref{8}, \textbf{we have this conclusion}:
    For large $\alpha$, whose atomic orbital is sharp, directly summation eq.\eqref{ao} has a faster convergence speed,
    and for small $\alpha$, which has gradual atomic orbital, eq.\eqref{ao_ft} has a faster convergence speed.
    

\section{PBC Hartree Fock}
    In this part, we will introduce Hartree Fock method on these PBC orbitals.
    Here we use index $\mu,\nu,\sigma,\rho$ to specify atoms,
    $p,q,r,s$ to specify atomic orbitals of each atom,
    $i,j,k,l$ to specify coefficients of each atomic orbital,
    $m,n$ to specify molecular orbital.
    Then the $p$ th PBC contracted GTO of $\mu$ th atom can be described as
    \begin{equation}
        \phi_{\textbf{k},p}(\textbf{r}-\textbf{R}_{\mu}) = \sum_{\textbf{T}}e^{i\textbf{k}\cdot\textbf{T}}\varphi_p(\textbf{r}-\textbf{R}_{\mu}-\textbf{T})
    \end{equation}
    or 
    \begin{equation}
        \phi_{\textbf{k},p}(\textbf{r}-\textbf{R}_{\mu}) = \sum_{\textbf{G}}\phi_{\textbf{k},p}(\textbf{G})e^{i(\textbf{k}+\textbf{G})\cdot(\textbf{r}-\textbf{R}_{\mu})}
    \end{equation}
    where
    \begin{equation}
        \phi_{\textbf{k},p}(\textbf{G}) = \frac{1}{\Omega}\int d\textbf{r}\ \varphi_p(\textbf{r})e^{-i(\textbf{k}+\textbf{G})\cdot\textbf{r}}
    \end{equation}
    In this part, we will show overlap, kinetic energy and local potential integrals both in real space and reciprocal space.
    To simplify the index, we will use the following abbreviations. The atoms indexs are incorporated into the orbitals indexs.
    \begin{equation}
        \phi_{\textbf{k},p}(\textbf{r}-\textbf{R}_{\mu}) \rightarrow \phi_{\textbf{k}p}(\textbf{r}) \notag
    \end{equation}

    % Here are some commonly used shorthand symbols.
    % \begin{gather*}
    %     \alpha_{ij} = \frac{\alpha_i\alpha_j}{\alpha_i+\alpha_j} \\
    %     \alpha_{ij,kl} = \frac{(\alpha_i+\alpha_j)(\alpha_k+\alpha_l)}{\alpha_i+\alpha_j+\alpha_k+\alpha_l} \\
    %     \textbf{R}_{\mu i,\nu j,c} = \frac{\alpha_i\textbf{R}_{\mu}+\alpha_j\textbf{R}_{\nu,c}}{\alpha_i+\alpha_j}
    % \end{gather*}

    \subsection{Integtals}
        Here are some commonly used tricks in this part. 
        Assume $\varphi(x)$ is a 1D atomic orbital, the 1D PBC atomic orbital is
        $$ \phi_{kp}(x) = \sum_{n=-\infty}^{+\infty}e^{inkT}\varphi_p(x-nT) $$
        or
        $$ \phi_{kp}(x) = \sum_{n=-\infty}^{+\infty}\phi_{k,p}(nG)e^{i(k+nG)x} $$
        General 1D integral of periodic operator $A(x)$ is given by
        $$ A_{pq}(k) = \int_0^Tdx\ \phi_{kp}^*(x)A(x)\phi_{kq}(x) $$
        In real space, the integral in a unit cell turns into infinite 1D integrals, 
        which always have analytical expressions for GTOs
        \begin{align*}
            A_{pq}(k) &= \int_0^Tdx\ \left[\sum_{m}e^{-imkT}\varphi_p(x-mT)\right]A(x)\left[\sum_{n}e^{inkT}\varphi_q(x-nT)\right] \\
            &= \sum_{m,n}e^{-i(m-n)kT}\int_{-mT}^{(-m+1)T}dx'\ \varphi_p(x')A(x'+mT)\varphi_q[x'+(m-n)T] \\
            &= \sum_{m,m-n}e^{-i(m-n)kT}\int_{-mT}^{(-m+1)T}dx'\ \varphi_p(x')A(x')\varphi_q[x'+(m-n)T] \\
            &= \sum_{n'}e^{-in'kT}\int_{-\infty}^{\infty}dx'\ \varphi_p(x')A(x')\varphi_q(x'+n'T)
        \end{align*}
        General 1D integral in reciprocal space is given by
        \begin{align*}
            A_{pq}(k) &= \int_0^Tdx\ \left[\sum_m\phi_{kp}^*(mG)e^{-i(k+mG)x}\right]A(x)\left[\sum_n\phi_{kq}(nG)e^{i(k+nG)x}\right] \\
            &= \sum_{m,n}\phi_{kp}^*(mG)\phi_{kq}(nG)\int_0^Tdx\ A(x)e^{i(n-m)Gx}
        \end{align*}
        The integrals in a unit cell sometimes have results like $\delta_{m,n}$.
        Of course there is a third way to get the integral result:
        we can always do numerical integration on a mesh in the unit cell,
        and sometimes it is worthy on account of FFT.
        
        \subsubsection{Overlap}
            The \textbf{overlap} matrix element is given by
            \begin{equation}
                S_{pq}(\textbf{k}) = \int_{\Omega}d\textbf{r}\ \phi_{\textbf{k}p}^*(\textbf{r})\phi_{\textbf{k}q}(\textbf{r})
            \end{equation}
            For PBC s-orbital GTOs,
            $$ \phi_{\textbf{k}p}(\textbf{r}) = \sum_{\textbf{T}}e^{i\textbf{k}\cdot\textbf{T}}\sum_ic_{pi}\left(\frac{2\alpha_i}{\pi}\right)^{\frac{3}{4}}
                e^{-\alpha_i(\textbf{r}-\textbf{T})^2} $$
            The result of real-space integration is   
            \begin{equation}
                S_{\mu pi,\nu qj,\textbf{T}}(\textbf{k}) = c_{pi}c_{qj}(\frac{2\sqrt{\alpha_i\alpha_j}}{\alpha_i+\alpha_j})^{\frac{3}{2}}
                e^{-i\textbf{k}\cdot\textbf{T}}e^{-\alpha_{ij}(\textbf{R}_{\mu}-\textbf{R}_{\nu}+\textbf{T})^2}
            \end{equation}
            \begin{equation}
                S_{pq}(\textbf{k}) = \sum_{ij\textbf{T}}S_{\mu pi,\nu qj,\textbf{T}}(\textbf{k})
            \end{equation}
            where $\alpha_{ij} = \frac{\alpha_i\alpha_j}{\alpha_i+\alpha_j}$.

            The \textbf{overlap} integral of reciprocal-space integration is
            \begin{equation}
                S_{pq}(\textbf{k}) = \Omega\sum_{\textbf{G}}\phi_{\textbf{k}p}(\textbf{G})\phi_{\textbf{k}q}(\textbf{G})
                e^{i(\textbf{G}+\textbf{k})\cdot(\textbf{R}_{\mu}-\textbf{R}_{\nu})}
            \end{equation}

        \subsubsection{Kinetic}
            The \textbf{kinetic} matrix element is given by
            \begin{equation}
                T_{pq}(\textbf{k}) = -\frac{1}{2}\int_{\Omega}d\textbf{r}\ \phi_{\textbf{k}p}^*(\textbf{r})\nabla_{\textbf{r}}^2
                \phi_{\textbf{k}q}(\textbf{r})
            \end{equation}
            The result of real-space integration is  
            \begin{equation}
                T_{pq}(\textbf{k}) = \sum_{ij\textbf{T}}S_{\mu pi,\nu qj,\textbf{T}}(\textbf{k})
                \alpha_{ij}\left[3-2\alpha_{ij}(\textbf{R}_{\mu}-\textbf{R}_{\nu}+\textbf{T})^2\right]
            \end{equation}
            The \textbf{kinetic} integral of reciprocal-space integration is
            \begin{equation}
                T_{pq}(\textbf{k}) = \frac{\Omega}{2}\sum_{\textbf{G}}\phi_{\textbf{k}p}(\textbf{G})\phi_{\textbf{k}q}(\textbf{G})
                e^{i(\textbf{G}+\textbf{k})\cdot(\textbf{R}_{\mu}-\textbf{R}_{\nu})}\cdot (\textbf{G}+\textbf{k})^2
            \end{equation}

        \subsubsection{Potential}
            The \textbf{local potential} matrix element is given by
            \begin{equation}
                V_{pq}^L(\textbf{k}) = \int_{\Omega}d\textbf{r}\ \phi_{\textbf{k}p}^*(\textbf{r})v^L(\textbf{r})\phi_{\textbf{k}q}(\textbf{r})
            \end{equation}
            The local potential is
            $$ v^L(\textbf{r}) = \sum_{\sigma}V(\textbf{r}-\textbf{R}_{\sigma}) = -\sum_{\sigma\textbf{T}}\frac{1}{|\textbf{r}-\textbf{R}_{\sigma}-\textbf{T}|} $$
            The two-gaussian integral has analytical result
            \begin{equation}
                V_{pq}^L(\textbf{k}) = -2\sum_{\sigma}\sum_{ij\textbf{T}\textbf{T}'}S_{\mu pi,\nu qj,\textbf{T}}\sqrt{\frac{\alpha_i+\alpha_j}{\pi}}
                F_0\left[(\alpha_i+\alpha_j)(\textbf{R}_{\sigma,\textbf{T}'}-\textbf{R}_{\mu i,\nu j,\textbf{T}})^2\right]\label{localp_divergent}
            \end{equation}
            where
            $$ F_0\left[x\right] = \frac{\sqrt{\pi}erf(\sqrt{x})}{2\sqrt{x}} \quad \& \quad F_0\left[0\right] = 1 $$
            and some shorthand symbols
            $$ \textbf{R}_{\sigma,\textbf{T}} = \textbf{R}_{\sigma}-\textbf{T} $$
            $$ \textbf{R}_{\mu i,\nu j,\textbf{T}} = \frac{\alpha_i\textbf{R}_{\mu}+\alpha_j\textbf{R}_{\nu,\textbf{T}}}{\alpha_i+\alpha_j} $$
            but this summation eq.\eqref{localp_divergent} is divergent.
            We should add a uniform negative charge density background to offset the positive charge without influencing the movement of electrons,
            or remove the $\textbf{k}=0$ term from the Fourier expansion.
            The Fourier expansion of Coulomb potential is
            \begin{equation}
                v(\textbf{r}) = -\sum_{\textbf{T}}\frac{1}{|\textbf{r}-\textbf{T}|}= -\sum_{\textbf{G}}V(\textbf{G})e^{i\textbf{G}\cdot\textbf{r}}
            \end{equation}
            where
            \begin{equation}
                V(\textbf{G}) = \frac{4\pi}{\Omega}\frac{1}{G^2}
            \end{equation}
            so eq.\eqref{localp_divergent} turns into
            \begin{equation}
                V_{pq}^L(\textbf{k}) = -\sum_{\sigma}\sum_{\textbf{G}\neq 0}\sum_{ij\textbf{T}}V(\textbf{G})S_{\mu pi,\nu qj,\textbf{T}}
                \exp\left[-i\textbf{G}\cdot(\textbf{R}_{\sigma}-\textbf{R}_{\mu i,\nu j,\textbf{T}})\right]\exp\left[-\frac{G^2}{4(\alpha_i+\alpha_j)}\right]\label{localp_real}
            \end{equation}
            (caution: something is still wrong with eq.\eqref{localp_real}.)
            In practice, obtaining $V(\textbf{r})$ from FFT and do numerical integration in a unit cell is a more economic way.
            \begin{equation*}
                v^L(\textbf{r}) = \sum_{\sigma}v(\textbf{r}-\textbf{R}_{\sigma}) = 
                -\sum_{\sigma\textbf{G}}V(\textbf{G})e^{i\textbf{G}\cdot(\textbf{r}-\textbf{R}_{\sigma})} =
                -\sum_{\textbf{G}}\left(\sum_{\sigma}e^{-i\textbf{G}\cdot\textbf{R}_{\sigma}}\right)V(\textbf{G})e^{i\textbf{G}\cdot\textbf{r}}
            \end{equation*}
            The structure factor
            \begin{equation}
                S(\textbf{G}) = \sum_{\sigma}e^{-i\textbf{G}\cdot\textbf{R}_{\sigma}}
            \end{equation}
            so the local potential becomes
            \begin{equation}
                v^L(\textbf{r}) = -\sum_{\textbf{G}}S(\textbf{G})V(\textbf{G})e^{i\textbf{G}\cdot\textbf{r}}
            \end{equation}
            In order to get local potential on the uniform grid in a unit cell, 
            we need do FFT on reciprocal lattice $\textbf{G}$.
            Take the 1D situation as an example.
            The 1D uniform grid in a unit cell $L$ is
            $$ 0,\frac{L}{n},\frac{2L}{n},\dots,\frac{(N-1)L}{n} $$
            The 1D reciprocal lattice is
            $$ 0,\frac{2\pi}{L},\frac{4\pi}{L},\dots,\frac{2(n-1)\pi}{L} $$
            The 1D inverse DFT is defined as
            \begin{equation}
                a_m = {\rm iFFT}(A_k) = \frac{1}{n}\sum_{k=0}^{n-1}A_k\exp\left\{2\pi i\frac{mk}{n}\right\}
            \end{equation}
            So the 1D local potential is
            \begin{equation}
                v^l(m\frac{L}{n}) = -n\cdot\frac{1}{n}\sum_{k=0}^{n-1}V(G_k)\exp\left\{i\cdot k\frac{2\pi}{L}\cdot m\frac{L}{n}\right\}
                = -n\cdot {\rm iFFT}\left[V(G_k)\right]\ {\rm for}\ m = 0,1,\dots,n-1
            \end{equation}
            where the mapping of $G_k$ to $G$ is
            \begin{equation}
                G_k = \begin{cases}
                    k\frac{2\pi}{L}, & if\ 0\leq k<n/2 \\
                    (k-n)\frac{2\pi}{L}, & if\ n/2\leq k<n
                \end{cases}
            \end{equation}
            The \textbf{local potential} integral of reciprocal-space integration is
            \begin{equation}
                V_{pq}^L(\textbf{k}) = -\Omega\sum_{\textbf{G}_1\textbf{G}_2}\phi_{\textbf{k}p}(\textbf{G}_1)\phi_{\textbf{k}q}(\textbf{G}_2)
                e^{i(\textbf{G}_1+\textbf{k})\cdot\textbf{R}_{\mu}}e^{-i(\textbf{G}_2+\textbf{k})\cdot\textbf{R}_{\nu}}S(\textbf{G}_1-\textbf{G}_2)V(\textbf{G}_1-\textbf{G}_2)
            \end{equation}         
            
        \subsubsection{Hartree and Exchange}
            The \textbf{Hartree} and \textbf{Exchange} term matrix element is given by
            \begin{equation}
                J_{pq}(\textbf{k}) = \int_{\Omega}d\textbf{r}\ \phi_{\textbf{k}p}^*(\textbf{r})
                \int d\textbf{r}'\ \rho(\textbf{r}')\frac{1}{\left|\textbf{r}-\textbf{r}'\right|}\phi_{\textbf{k}q}(\textbf{r})\label{hartree}
            \end{equation}
            \begin{equation}
                K_{pq}(\textbf{k}) = \int_{\Omega}d\textbf{r}\ \int d\textbf{r}'\ \phi_{\textbf{k}p}^*(\textbf{r})
                \frac{\rho(\textbf{r},\textbf{r}')}{\left|\textbf{r}-\textbf{r}'\right|}\phi_{\textbf{k}q}(\textbf{r}')\label{exchange}
            \end{equation}
            where the electron density $\rho(\textbf{r},\textbf{r}')$ is an average of all k-points in the Brillouin zone
            \begin{align}
                \rho(\textbf{r},\textbf{r}') &= \frac{2}{N_k}\sum_{\textbf{k}}\sum_m^{occ}\psi_{\textbf{k}m}(\textbf{r})\psi_{\textbf{k}m}^*(\textbf{r}')\notag\\
                &= \frac{1}{N_k}\sum_{\textbf{k}}\sum_{rs}P_{rs}(\textbf{k})\phi_{\textbf{k}r}(\textbf{r})
                    \phi_{\textbf{k}s}^*(\textbf{r}')
            \end{align}
            and the one electron density is
            \begin{equation}
                \rho(\textbf{r}) = \rho(\textbf{r},\textbf{r}) = \frac{1}{N_k}\sum_{\textbf{k}}\sum_{rs}
                P_{rs}(\textbf{k})\rho_{r\textbf{k},s\textbf{k}}(\textbf{r})
            \end{equation}
            the density matrix is given by
            \begin{equation}
                P_{rs}(\textbf{k}) = 2\sum_m^{occ}C_{rm}(\textbf{k})C_{sm}^*(\textbf{k})
            \end{equation}
            the coefficients $C_{rm}$ are molecular orbital coefficients
            \begin{equation}
                \psi_{\textbf{k}m}(\textbf{r}) = \sum_{r}C_{rm}(\textbf{k})\phi_{\textbf{k}r}(\textbf{r})
            \end{equation} 
            in practical code the Hartree matrix eq.\eqref{hartree} is given by
            \begin{equation}
                J_{pq}(\textbf{k}) = \int_{\Omega}d\textbf{r}\ \phi_{\textbf{k}p}^*(\textbf{r})
                v_H(\textbf{r})\phi_{\textbf{k}q}(\textbf{r})\label{hartree_code}
            \end{equation}
            in terms of Hartree potential
            \begin{equation}
                v_H(\textbf{r}) = \int d\textbf{r}'\ \rho(\textbf{r}')\frac{1}{\left|\textbf{r}-\textbf{r}'\right|} 
                = \frac{4\pi}{\Omega}\sum_{\textbf{G}\neq 0}\frac{\rho(\textbf{G})}{G^2}e^{i\textbf{G}\cdot\textbf{r}}
            \end{equation}
            where
            \begin{align}
                \rho(\textbf{G}) &= \int_{\Omega}d\textbf{r}\ \rho(\textbf{r})e^{-i\textbf{G}\cdot\textbf{r}}\notag\\
                &= \frac{1}{N_k}\sum_{\textbf{k}}\sum_{rs}P_{rs}(\textbf{k})\int_{\Omega}d\textbf{r}\ 
                    \phi_{\textbf{k}r}(\textbf{r})\phi_{\textbf{k}s}^*(\textbf{r})e^{-i\textbf{G}\cdot\textbf{r}}\notag\\
                &= \frac{1}{N_k}\sum_{\textbf{k}}\sum_{rs}P_{rs}(\textbf{k})\rho_{r\textbf{k},s\textbf{k}}(\textbf{G})
            \end{align}
            the exchange matrix is given by
            \begin{equation}
                K_{pq}(\textbf{k}) = \frac{1}{N_k}\sum_{\textbf{k}'}\sum_{rs}P_{rs}(\textbf{k}')\int_{\Omega} d\textbf{r}\ 
                \phi_{\textbf{k}p}^*(\textbf{r})v_{q\textbf{k},s\textbf{k}'}^X(\textbf{r})\phi_{\textbf{k}'r}(\textbf{r})
            \end{equation}
            in terms of exchange potential
            \begin{align}
                v_{q\textbf{k},s\textbf{k}'}^X(\textbf{r}) 
                &= \int d\textbf{r}'\ \frac{\phi_{\textbf{k}q}(\textbf{r}')
                    \phi_{\textbf{k}'s}^*(\textbf{r}')}{\left|\textbf{r}-\textbf{r}'\right|}\notag\\
                &= \int d\textbf{r}'\ \frac{\rho_{q\textbf{k},s\textbf{k}'}(\textbf{r}')}{\left|\textbf{r}-\textbf{r}'\right|}\notag \\
                &= \frac{4\pi}{\Omega}\sum_{\textbf{G}}^{,}\frac{\rho_{q\textbf{k},s\textbf{k}'}(\textbf{G})}
                    {\left|\textbf{k}-\textbf{k}'+\textbf{G}\right|^2}e^{i(\textbf{k}-\textbf{k}'+\textbf{G})\cdot\textbf{r}}
            \end{align}
            where
            \begin{equation}
                \rho_{q\textbf{k},s\textbf{k}'}(\textbf{r}) = \phi_{\textbf{k}q}(\textbf{r})\phi_{\textbf{k}'s}^*(\textbf{r}) 
                = \sum_{\textbf{G}}\rho_{q\textbf{k},s\textbf{k}'}(\textbf{G})e^{i(\textbf{k}-\textbf{k}'+\textbf{G})\cdot\textbf{r}}
            \end{equation}
            \begin{equation}
                \rho_{q\textbf{k},s\textbf{k}'}(\textbf{G}) = \int_{\Omega}d\textbf{r}\ \rho_{q\textbf{k},s\textbf{k}'}(\textbf{r})
                e^{-i(\textbf{k}-\textbf{k}'+\textbf{G})\cdot\textbf{r}}
            \end{equation}
            So we can get the final expression of Hartree and exchange matrix
            \begin{equation}
                J_{pq}(\textbf{k}) = \frac{4\pi}{\Omega}\frac{1}{N_k}\sum_{\textbf{k}'}\sum_{rs}
                P_{rs}(\textbf{k}') \int_{\Omega}d\textbf{r}\ \phi_{\textbf{k}p}^*(\textbf{r})
                \sum_{\textbf{G}\neq 0}\frac{\rho_{r\textbf{k}',s\textbf{k}'}(\textbf{G})}{G^2}e^{i\textbf{G}\cdot\textbf{r}}
                \phi_{\textbf{k}q}(\textbf{r})
            \end{equation}
            \begin{equation}
                K_{pq}(\textbf{k}) = \frac{4\pi}{\Omega}\frac{1}{N_k}\sum_{\textbf{k}'}\sum_{rs}P_{rs}(\textbf{k}')
                \int_{\Omega} d\textbf{r}\ \phi_{\textbf{k}p}^*(\textbf{r})\sum_{\textbf{G}}^{,}\frac{\rho_{q\textbf{k},s\textbf{k}'}(\textbf{G})}
                {\left|\textbf{k}-\textbf{k}'+\textbf{G}\right|^2}e^{i(\textbf{k}-\textbf{k}'+\textbf{G})\cdot\textbf{r}}\phi_{\textbf{k}',r}(\textbf{r})
            \end{equation}
            

        % \subsubsection{Electron interaction}
        %     The interaction matrix element
        %     \begin{equation}
        %         E_{p\mu q\nu,r\gamma s\eta} = \bra{\alpha_p\textbf{R}_{\mu}\alpha_q\textbf{R}_{\nu}}
        %         \frac{1}{|r-r'|}\ket{\alpha_r\textbf{R}_{\gamma}\alpha_s\textbf{R}_{\eta}} 
        %         = 2 O_{p\mu,r\gamma}O_{q\nu,s\eta}\sqrt{\frac{\alpha_{pr,qs}}{\pi}}
        %         F_0\left[\alpha_{pr,qs}(\textbf{R}_{p\mu,r\gamma}-\textbf{R}_{q\nu,r\eta})^2\right]
        %     \end{equation}
        %     Where
        %     \begin{equation}
        %         F_0\left[x\right] = \frac{\sqrt{\pi}erf(\sqrt{x})}{2\sqrt{x}} \quad \& \quad F_0\left[0\right] = 1
        %     \end{equation}
            
        % \subsubsection{Hcore}
        %     Hamiltonian matrix element without interaction
        %     \begin{equation}
        %         h_{p\mu,q\nu} = T_{p\mu,q\nu} - \sum_{N}V_{p\mu,q\nu,N}
        %     \end{equation}
        % \subsubsection{Fock matrix}
        %     Fock operator matrix element
        %     \begin{equation}
        %         F_{p\mu,q\nu} = \bra{\alpha_p\textbf{R}_{\mu}}\hat{H}\ket{\alpha_q\textbf{R}_{\nu}} 
        %         = h_{p\mu,q\nu} + \sum_{k}\sum_{r\gamma,s\eta} 
        %         (2E_{p\mu r\gamma,q\nu s\eta}-E_{p\mu r\gamma,s\eta q\nu})C_{r\gamma,k}^*C_{s\eta,k}
        %     \end{equation}

    \subsection{Solution of generalised eigenvalue problem}
        Core Hamiltonian matrix element without interaction
        \begin{equation}
            \textbf{H}(\textbf{k}) = \textbf{T}(\textbf{k}) + \textbf{V}^L(\textbf{k})
        \end{equation}
        Fock operator
        \begin{equation}
            \textbf{F}(\textbf{k}) = \textbf{H}(\textbf{k})+\textbf{J}(\textbf{k})-\frac{1}{2}\textbf{K}(\textbf{k})
        \end{equation}
        Roothaan equation
        \begin{equation}
            \textbf{F}(\textbf{k})\textbf{C}(\textbf{k}) = \epsilon(\textbf{k})\textbf{S}(\textbf{k})\textbf{C}(\textbf{k})
        \end{equation}
        This is a generalised eigenvalue problem since these bases are not orthogonal to each other. 
        To change the bases, solve the eigenvalue equation of $\textbf{S}$
        $$ \textbf{SU} = \textbf{Us} $$
        Then the unitary matrix $\textbf{U}$ can diagonalise $\textbf{S}$
        $$ \textbf{U}^\dagger\textbf{SU} = \textbf{\textbf{s}} $$
        Define matrix $\textbf{V}$
        \begin{equation}
            \textbf{V} \equiv \textbf{Us}^{-1/2}
        \end{equation}
        Then we have
        $$ \textbf{V}^\dagger\textbf{SV} = \textbf{s}^{-1/2}\textbf{U}^\dagger\textbf{SUs}^{-1/2} = \textbf{I} $$
        Then the eigenvalue equation $\textbf{HC} = \textbf{SCE}$ turns into
        $$ \textbf{V}^\dagger\textbf{HVV}^{-1}\textbf{C} =  \textbf{V}^\dagger\textbf{SVV}^{-1}\textbf{C}\textbf{E} = \textbf{V}^{-1}\textbf{C}\textbf{E} $$
        define
        \begin{align}
            \textbf{H}' &\equiv \textbf{V}^\dagger\textbf{HV}\\
            \textbf{C}' &\equiv \textbf{V}^{-1}\textbf{C}
        \end{align}
        We can rewrite the eigenvalue equation as
        \begin{equation}
            \textbf{H}'\textbf{C}' = \textbf{C}'\textbf{E}
        \end{equation}
        Solve this eigenvalue problem then we can get the eigenvalues $\textbf{E}$ and the eigenstate $\textbf{C}'$
        Then the eigenstate of the generalised eigenvalue problem is
        \begin{equation}
            \textbf{C} = \textbf{V}\textbf{C}'
        \end{equation}
        The elements in matrix $\textbf{C}$ are coefficients transform the atomic orbitals to molecular orbitals.
        The shape of $\textbf{C}(\textbf{k})$ is $(n_{ao}, n_{mo})$.
        In hydrogen problem, assuming $N$ hydrogen atoms per unit cell, 
        the HF determinant includes the $N_kN$ orbitals with the lowest eigenvalues out of all k-points.
        We can get the density matrix
        \begin{equation}
            P_{rs}(\textbf{k}) = 2\sum_m^{occ}C_{rm}(\textbf{k})C_{sm}^*(\textbf{k})
        \end{equation}
        The energy is
        \begin{equation}
            E(\textbf{k}) = \frac{1}{2}\sum_{pq}\left[F_{pq}(\textbf{k})+H_{pq}(\textbf{k})\right]P_{qp}(\textbf{k})
        \end{equation}
        Note that the nuclear-nuclear repulsion,
        which is computed using the Ewald expression, is excluded from this energy.
        The molecular orbitals are
        \begin{equation}
            \psi_{\textbf{k}m}(\textbf{r}) = \sum_{r}C_{rm}(\textbf{k})\phi_{\textbf{k}r}(\textbf{r})
        \end{equation} 

        % One method is turning the equation into 
        % $$ (\textbf{S}^{-1}\textbf{H})\textbf{C} = \textbf{CE} $$
        % Solve the new eigenvalue equation, notice that $(\textbf{S}^{-1}\textbf{H})$ is non-Hermitian matrix.\par

\end{document}